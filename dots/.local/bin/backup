#!/usr/bin/env bash
# ~/.local/bin/backup
# Usage:
#   backup [--local] <file-or-directory>
# Options:
#   --local    Create a .bak file next to the original instead of using ~/.local/backups/
#   -h, --help Show this help message

set -euo pipefail

show_help() {
    cat << EOF
Usage: backup [OPTIONS] <file-or-directory>

Backs up a file or directory.

Options:
  --local        Create a .bak file next to the original instead of using ~/.local/backups/
  -h, --help     Show this help message
EOF
}

# If no arguments or help requested, show help
if [[ $# -eq 0 ]]; then
    show_help
    exit 0
fi

if [[ "$1" == "-h" || "$1" == "--help" ]]; then
    show_help
    exit 0
fi

# Parse options
LOCAL_BACKUP=0
if [[ "$1" == "--local" ]]; then
    LOCAL_BACKUP=1
    shift
fi

# Ensure a target was provided
if [[ $# -lt 1 ]]; then
    echo "Error: No target specified."
    show_help
    exit 1
fi

TARGET="$1"

# Verify target exists
if [[ ! -e "$TARGET" ]]; then
    echo "Error: '$TARGET' does not exist."
    exit 1
fi

# Backup
if [[ $LOCAL_BACKUP -eq 1 ]]; then
    # Create .bak file in the same directory
    BACKUP_PATH="${TARGET}.bak"
    if [[ -e "$BACKUP_PATH" ]]; then
        echo "Error: '$BACKUP_PATH' already exists. Choose a different name or remove it."
        exit 1
    fi

    if [[ -d "$TARGET" ]]; then
        cp -a "$TARGET" "$BACKUP_PATH"
    else
        cp "$TARGET" "$BACKUP_PATH"
    fi
    echo "Local backup created at '$BACKUP_PATH'"

else
    # Create timestamped backup in ~/.local/backups/
    BACKUP_DIR="$HOME/.local/backups"
    mkdir -p "$BACKUP_DIR"

    BASENAME="$(basename "$TARGET")"
    TIMESTAMP="$(date +'%Y%m%d_%H%M%S')"
    BACKUP_PATH="$BACKUP_DIR/${BASENAME}_$TIMESTAMP"

    if [[ -d "$TARGET" ]]; then
        cp -a "$TARGET" "$BACKUP_PATH"
    else
        cp "$TARGET" "$BACKUP_PATH"
    fi
    echo "Timestamped backup created at '$BACKUP_PATH'"
fi

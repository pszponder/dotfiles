#!/usr/bin/env bash
# web2app.sh - Create a desktop launcher for a web app using Brave, Chrome, or Chromium

set -euo pipefail

# ------------------------
# 🔧 Validate Arguments
# ------------------------
if [ "$#" -ne 3 ]; then
  echo "Usage: $0 <AppName> <AppURL> <IconURL>"
  echo "Example: $0 'Gmail' 'https://mail.google.com' 'https://example.com/gmail.png'"
  exit 1
fi

APP_NAME="$1"
APP_URL="$2"
ICON_URL="$3"

ICON_DIR="$HOME/.local/share/applications/icons"
ICON_PATH="${ICON_DIR}/${APP_NAME}.png"
DESKTOP_FILE="$HOME/.local/share/applications/${APP_NAME}.desktop"

mkdir -p "$ICON_DIR"

# ------------------------
# 🌐 Detect Available Browser
# ------------------------
get_browser_command() {
  local candidates=("brave" "brave-browser" "google-chrome" "chromium" "chromium-browser")

 local browser_cmd=""

  for cmd in "${browser_candidates[@]}"; do
    if command -v "$cmd" &>/dev/null; then
      browser_cmd="$(command -v "$cmd")"
      break
    fi
  done

  if [[ -z "$browser_cmd" ]]; then
    echo "❌ No supported browser found (brave, chrome, chromium)." >&2
    exit 1
  fi

  echo "🌐 Using browser: $browser_cmd"
}

BROWSER_CMD=$(get_browser_command)
echo "🌐 Using browser: $BROWSER_CMD"

# ------------------------
# 🖼 Download Icon
# ------------------------
if ! curl -fsSL -o "$ICON_PATH" "$ICON_URL"; then
  echo "❌ Failed to download icon from $ICON_URL"
  exit 1
fi

# ------------------------
# 🖥 Create .desktop Entry
# ------------------------
cat > "$DESKTOP_FILE" <<EOF
[Desktop Entry]
Version=1.0
Name=$APP_NAME
Comment=$APP_NAME Web App
Exec=$BROWSER_CMD --app="$APP_URL" --class="$APP_NAME"
Terminal=false
Type=Application
Icon=$ICON_PATH
Categories=Network;WebBrowser;
StartupNotify=true
EOF

chmod +x "$DESKTOP_FILE"

echo "✅ Desktop launcher created for $APP_NAME using $BROWSER_CMD"
